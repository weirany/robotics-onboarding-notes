下面按“你真的能照着敲、能录到、能回放、能用回放喂下游节点”的标准，给你一套 Day 5 rosbag2（ROS2 的 rosbag）实操流程。示例用 **turtlesim**，但我会把“评测/回放平台”的思路也一起讲清楚。

> 说明：ROS2 里常用的是 **rosbag2**，CLI 命令是 `ros2 bag ...`。官方 Humble 教程就是用 turtlesim 练这个流程。 ([ROS Docs][1])

---

## 0) 你要先能讲出来的 3 句话（未来卖点）

1. **rosbag = 机器人系统的“可回放数据资产”**：把 topic 上的消息（带时间戳）打包成数据集，随时复现现场。 ([ROS Docs][1])
2. **调试/复现/回归测试/离线评测** 的核心：你把“输入”固定（bag），就能反复跑不同版本的算法/节点，做回归对比。 ([ROS Docs][1])
3. **回放驱动下游节点**：回放 bag 就是在“伪造传感器/上游模块输出”，下游节点像接真实机器人一样工作（但你可以暂停/加速/重复）。ROS 的时间抽象（/clock, use_sim_time）就是为“回放/仿真可控时间”服务的。 ([design.ros2.org][2])

---

## 1) 环境准备（一次确认，避免踩坑）

打开一个新终端（每个终端都要 source）：

```bash
source /opt/ros/$ROS_DISTRO/setup.bash
echo $ROS_DISTRO
ros2 --version
ros2 bag --help
```

确保 turtlesim 有装（没有就装）：

```bash
sudo apt update
sudo apt install -y ros-$ROS_DISTRO-turtlesim
```

> 官方教程也默认你已经装好 `ros2 bag`（rosbag2）并会用 turtlesim。 ([ROS Docs][1])

建议建一个 Day5 目录（跟你之前 day-2 的节奏一致）：

```bash
mkdir -p ~/Projects/robotics-onboarding-notes/day-5/{notes,bag_files,scripts}
cd ~/Projects/robotics-onboarding-notes/day-5
```

---

## 2) 实战 A：启动 turtlesim（产生可录的 topic）

开 **3 个终端**（都记得 source）。

### 终端 1：turtlesim 画面

```bash
source /opt/ros/$ROS_DISTRO/setup.bash
ros2 run turtlesim turtlesim_node
```

### 终端 2：键盘控制（发布 /turtle1/cmd_vel）

```bash
source /opt/ros/$ROS_DISTRO/setup.bash
ros2 run turtlesim turtle_teleop_key
```

### 终端 3：看看有哪些 topic

```bash
source /opt/ros/$ROS_DISTRO/setup.bash
ros2 topic list
```

你应该能看到类似这些：`/turtle1/cmd_vel`、`/turtle1/pose` 等。 ([ROS Docs][1])

---

## 3) 任务 1：录制一个 topic（最小闭环）

我们先录 **/turtle1/cmd_vel**（键盘控制发出的速度指令）。在终端 3：

```bash
cd ~/Projects/robotics-onboarding-notes/day-5/bag_files
ros2 bag record -o cmdvel_only /turtle1/cmd_vel
```

回到终端 2，用方向键让乌龟走出一个“好识别”的图形（比如方形/三角形），录 10～20 秒，然后在录制的终端按 `Ctrl+C` 停止。

你会得到一个目录（里面有 `metadata.yaml` 和实际数据文件）。官方教程也明确：bag 会保存为一个目录，含 `metadata.yaml` 等。 ([ROS Docs][1])

---

## 4) 任务 2：查看 bag 信息（ros2 bag info）

```bash
cd ~/Projects/robotics-onboarding-notes/day-5/bag_files
ros2 bag info cmdvel_only
```

你会看到：

* duration / start / end
* topic 名称、消息类型、message count
* storage id（不同发行版默认可能不同，Humble 教程示例里常见 sqlite3） ([ROS Docs][1])

---

## 5) 任务 3：回放 bag（驱动订阅者消费）

### 回放方式 1：让 turtlesim “复现运动”（bag 当作上游输入）

关键点：**先停掉 teleop**（不然你手动也在发 cmd_vel，会干扰复现）。按官方做法在 teleop 终端 `Ctrl+C`。 ([ROS Docs][1])

保持 **turtlesim_node 还在运行**（终端 1 不要停），然后在终端 3：

```bash
cd ~/Projects/robotics-onboarding-notes/day-5/bag_files
ros2 bag play cmdvel_only
```

你会看到乌龟按你当时的按键节奏再走一遍（不一定 100% 像，因为系统时序会有细微差异；官方也提过 turtlesim 对 timing 很敏感）。 ([ROS Docs][1])

---

## 6) （加分）录多个 topic，并对比回放效果

这次录 **/turtle1/cmd_vel + /turtle1/pose**：

```bash
cd ~/Projects/robotics-onboarding-notes/day-5/bag_files
ros2 bag record -o cmdvel_pose /turtle1/cmd_vel /turtle1/pose
```

录一会儿后 `Ctrl+C`，然后：

```bash
ros2 bag info cmdvel_pose
```

官方示例就是这么录多个 topic，并解释了 `-o` 命名与 topic count 的差异（pose 会高频发布，所以 count 很大）。 ([ROS Docs][1])

### 对比回放效果（很重要的“评测思维”）

* 如果你 **启动 turtlesim_node 并回放 cmdvel_pose**：

  * `/turtle1/cmd_vel` 会驱动乌龟走
  * 但 `/turtle1/pose` 同时会有 **bag 在发** + **turtlesim 自己也在发**（两个 publisher）→ 下游订阅者可能会看到“混杂数据”
* 所以评测/回归时，常见做法是：

  * **要复现控制效果**：只回放 cmd_vel（或回放时只选 cmd_vel）
  * **要离线评测算法**：不跑 turtlesim，让 bag 的 pose 当“传感器输入”喂给下游

你可以用 `--topics` 精准选择回放哪些 topic：rosbag2 README 明确支持 `--topics` / `--exclude-topics` / regex 等过滤。 ([GitHub][3])

比如：**只用 cmd_vel 驱动 turtlesim（避免回放 pose）**：

```bash
ros2 bag play cmdvel_pose --topics /turtle1/cmd_vel
```

---

## 7) 回放驱动“下游节点”（你未来平台的核心套路）

这里给你两种下游消费方式：**零代码** 和 **小脚本**。

### 方式 A：零代码下游（用 CLI 当订阅者）

先别开 turtlesim（避免 pose 混杂），只做离线回放 + 观察：

**终端 1（订阅者）**：

```bash
source /opt/ros/$ROS_DISTRO/setup.bash
ros2 topic echo /turtle1/pose
```

**终端 2（回放 bag）**：

```bash
source /opt/ros/$ROS_DISTRO/setup.bash
cd ~/Projects/robotics-onboarding-notes/day-5/bag_files
ros2 bag play cmdvel_pose --topics /turtle1/pose
```

你会看到 echo 开始持续打印 Pose——这就是“回放驱动下游消费者”。

### 方式 B：写一个“评测记录器”节点（把 pose 落 CSV）

在 `~/Projects/robotics-onboarding-notes/day-5/scripts/pose_logger.py` 新建文件：

```python
#!/usr/bin/env python3
import csv
import rclpy
from rclpy.node import Node
from turtlesim.msg import Pose

class PoseLogger(Node):
    def __init__(self, out_csv: str):
        super().__init__('pose_logger')
        self._f = open(out_csv, 'w', newline='')
        self._w = csv.writer(self._f)
        self._w.writerow(['t_sec', 'x', 'y', 'theta', 'linear_velocity', 'angular_velocity'])
        self.create_subscription(Pose, '/turtle1/pose', self.cb, 10)
        self.get_logger().info(f"Logging /turtle1/pose to {out_csv}")

    def cb(self, msg: Pose):
        t = self.get_clock().now().nanoseconds / 1e9
        self._w.writerow([t, msg.x, msg.y, msg.theta, msg.linear_velocity, msg.angular_velocity])

    def destroy_node(self):
        try:
            self._f.close()
        except Exception:
            pass
        super().destroy_node()

def main():
    rclpy.init()
    node = PoseLogger('pose_log.csv')
    try:
        rclpy.spin(node)
    except KeyboardInterrupt:
        pass
    node.destroy_node()
    rclpy.shutdown()

if __name__ == '__main__':
    main()
```

运行：

**终端 1（logger）**：

```bash
source /opt/ros/$ROS_DISTRO/setup.bash
cd ~/Projects/robotics-onboarding-notes/day-5/scripts
chmod +x pose_logger.py
./pose_logger.py
```

**终端 2（回放 pose）**：

```bash
source /opt/ros/$ROS_DISTRO/setup.bash
cd ~/Projects/robotics-onboarding-notes/day-5/bag_files
ros2 bag play cmdvel_pose --topics /turtle1/pose
```

回放结束后在 logger 终端 `Ctrl+C`，你会得到 `pose_log.csv`。
这就是你未来“offline eval”平台最小雏形：**bag（固定输入）→ 节点产出日志（可对比）**。

---

## 8) 你以后做平台一定会用到的 rosbag2 常用开关（不用全记，先知道存在）

### 8.1 选择回放内容（避免干扰）

* `ros2 bag play ... --topics ...`
* `--exclude-topics ...`
* `-e/--regex`、`-x/--exclude-regex`
  这些能力在 rosbag2 README 里写得很清楚。 ([GitHub][3])

### 8.2 回放速率/循环

很多版本的 `ros2 bag play --help` 里会有：

* `-r/--rate`：加速/减速回放
* `-l/--loop`：循环回放
  （以你本机 `--help` 为准） ([Manual RO47003][4])

### 8.3 切分与压缩（真机录大包必备）

rosbag2 支持：

* 按大小/时间切分：`-b` / `-d`
* 压缩：`--compression-mode file --compression-format zstd`
  ([GitHub][3])

### 8.4 存储格式（sqlite3 vs mcap）

rosbag2 支持多种 storage plugin，并可用 `--storage <id>` 指定；README 里也提到 mcap/sqlite3 与默认值、以及如何强制读取。 ([GitHub][3])
如果你想了解 MCAP 插件本身：`rosbag2_storage_mcap` 文档在 ROS 官方站点也有。 ([ROS Docs][5])

### 8.5 QoS 不匹配时怎么办（回放“收不到消息”的常见原因）

可以用 `--qos-profile-overrides-path` 给特定 topic 覆盖 QoS（录制/回放都支持）。 ([GitHub][3])

### 8.6 Simulation time（/clock, use_sim_time）

* ROS 的时间抽象允许你在回放/仿真时“控制时间进度”（暂停、加速等），核心是 `/clock` 和节点参数 `use_sim_time`。 ([design.ros2.org][2])
* rosbag2 也有 `--use-sim-time` 相关注意事项（比如没收到 `/clock` 前不会写消息等）。 ([GitHub][3])

---

## 9) 你要交付的输出：`notes/day5_rosbag.md`（可直接复制当模板）

把下面内容存成：`~/Projects/robotics-onboarding-notes/day-5/notes/day5_rosbag.md`

````md
# Day 5 — rosbag2（录制 / 回放 / 调试基础）

## 今日目标
- 会用：ros2 bag record / info / play
- 能解释：为什么 bag 是“可回放数据资产”
- 能做到：回放 bag 驱动下游订阅者，完成最小 offline eval

## 环境信息
- ROS_DISTRO: <填你的>
- OS: Ubuntu <填版本>
- 机器：<VM/裸机/ARM?>

## 实战记录

### 1) 启动 turtlesim
```bash
ros2 run turtlesim turtlesim_node
ros2 run turtlesim turtle_teleop_key
ros2 topic list
````

### 2) 录单 topic（/turtle1/cmd_vel）

```bash
cd day-5/bag_files
ros2 bag record -o cmdvel_only /turtle1/cmd_vel
# teleop 里走图形 -> Ctrl+C 停止录制
ros2 bag info cmdvel_only
```

### 3) 回放驱动 turtlesim

```bash
# 先 Ctrl+C 停止 teleop
ros2 bag play cmdvel_only
```

### 4) 录多 topic（/turtle1/cmd_vel + /turtle1/pose）

```bash
ros2 bag record -o cmdvel_pose /turtle1/cmd_vel /turtle1/pose
ros2 bag info cmdvel_pose
```

### 5) 回放驱动下游订阅者（offline eval 雏形）

* 方式A：ros2 topic echo

```bash
ros2 topic echo /turtle1/pose
ros2 bag play cmdvel_pose --topics /turtle1/pose
```

* 方式B：自写 pose_logger（输出 CSV）
  （贴上你的 pose_logger.py 或记录命令）

## 思考总结（你的“未来卖点”）

* bag 为什么是数据资产？
* 用 bag 怎么做 regression/debug/offline eval？
* 你在这个练习里，哪些点最像你做搜索/ML评测？

```

---

## 10) 小建议：bag 文件怎么放到 repo 里？
- bag 目录通常比较大，**不建议直接 git commit**（除非很小）。  
- 你可以在 repo 里只提交：
  - `notes/day5_rosbag.md`
  - `scripts/pose_logger.py`
  - 一条命令记录 +（可选）一个很小的 bag 样例  
- 或者把 bag 放在 `bag_files/` 并加入 `.gitignore`。

---

如果你愿意，我也可以基于你下一步的目标（“做回放/评测平台”）把 Day5 的内容往前推半步：给你一个“bag → 运行某个节点/launch → 自动产出 metrics/csv → 与 baseline diff”的最小框架（偏工程化的那种）。
::contentReference[oaicite:20]{index=20}
```

[1]: https://docs.ros.org/en/humble/Tutorials/Beginner-CLI-Tools/Recording-And-Playing-Back-Data/Recording-And-Playing-Back-Data.html "Recording and playing back data — ROS 2 Documentation: Humble  documentation"
[2]: https://design.ros2.org/articles/clock_and_time.html "Clock and Time"
[3]: https://github.com/ros2/rosbag2 "GitHub - ros2/rosbag2"
[4]: https://manual.ro47003.me.tudelft.nl/6_common_tools/rosbags.html?utm_source=chatgpt.com "6.3. Recording data with ROS bags"
[5]: https://docs.ros.org/en/jazzy/p/rosbag2_storage_mcap/index.html?utm_source=chatgpt.com "rosbag2_storage_mcap: Jazzy 0.26.9 documentation"
