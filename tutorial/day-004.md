([Past chat][1])([Past chat][2])([Past chat][3])([Past chat][4])

太好了，这个 Day 4 很关键——你会开始从“单点 demo”切到“系统编排”的思维。

下面我给你一套**能直接执行**的版本（基于 ROS2 Python package，适用于 Humble/Jazzy，写法基本一致）。我会默认你已经有一个 Day1 的 `topic_demo`（或类似名字）包，以及 Day2 的 `service_demo` 包。**如果你的包名不一样，按我标注替换即可。**

---

# Day 4 —— Launch（一键启动多个节点）

## 今天目标（你会做成什么）

你会写一个 `launch/bringup.launch.py`，一条命令启动：

* publisher node
* subscriber node
* （可选）service server

并且从命令行传参数进去，例如：

* 发布消息内容 `msg`
* 发布频率 `period`
* 命名空间 `ns`
* topic 重映射 `topic_name`
* 是否启动 service `start_service`

---

# 先讲概念（你要能讲出来）

### 1) launch file 是干嘛的？

`launch` 就是 ROS2 的“系统编排入口”（orchestrator）：

* 一次启动多个节点
* 统一参数配置
* 做命名空间隔离
* 做 topic remap
* 方便复现实验与调试（别人一条命令就能复现你的运行环境）

> 这就是为什么工程里几乎不会靠手动开 5 个终端逐个 `ros2 run`。

### 2) 参数传递（今天做到“会传就行”）

`ros2 launch ... arg:=value`
Launch 收到参数后，再把参数传给 node。

### 3) 命名空间 / 重映射（今天先知道概念）

* **命名空间（namespace）**：给一组节点/话题加前缀，避免冲突
  例如 `ns:=lab1` 后，`/chatter` 可能变成 `/lab1/chatter`
* **重映射（remap）**：把节点代码里的 topic 名字映射到实际运行名字
  例如代码写的是 `chatter`，运行时 remap 成 `my_topic`

---

# 目录结构（你今天最终至少会有）

假设你的包叫 `topic_demo`（替换成你的实际包名）：

```bash
ros2_ws/src/topic_demo/
├── launch/
│   └── bringup.launch.py      # ✅ 今天核心产物
├── topic_demo/
│   ├── __init__.py
│   ├── talker_param.py        # （建议新增，用于演示参数传递）
│   └── listener.py            # 你 Day1 的 subscriber（已有则复用）
├── package.xml
└── setup.py
```

另外你的笔记 repo 里会有：

```bash
notes/day4_launch.md           # ✅ 今天留痕
```

---

# Part A：先准备一个“可接参数”的 publisher（建议）

> 如果你 Day1 的 publisher 还不支持参数，这一步很值得做。
> 如果你已经有支持参数的 publisher，可跳到 Part B。

## 1) 新建 `talker_param.py`

路径（示例）：
`ros2_ws/src/topic_demo/topic_demo/talker_param.py`

```python
import rclpy
from rclpy.node import Node
from std_msgs.msg import String


class ParamTalker(Node):
    def __init__(self):
        super().__init__('param_talker')

        # 声明参数（默认值）
        self.declare_parameter('publish_text', 'hello from launch')
        self.declare_parameter('period_sec', 1.0)

        self.publisher_ = self.create_publisher(String, 'chatter', 10)

        period = float(self.get_parameter('period_sec').value)
        self.timer = self.create_timer(period, self.timer_callback)

        self.count = 0
        self.get_logger().info(
            f'ParamTalker started. topic=chatter, period={period}s'
        )

    def timer_callback(self):
        text = str(self.get_parameter('publish_text').value)
        msg = String()
        msg.data = f'{text} [{self.count}]'
        self.publisher_.publish(msg)
        self.get_logger().info(f'Publishing: "{msg.data}"')
        self.count += 1


def main(args=None):
    rclpy.init(args=args)
    node = ParamTalker()
    try:
        rclpy.spin(node)
    except KeyboardInterrupt:
        pass
    node.destroy_node()
    rclpy.shutdown()


if __name__ == '__main__':
    main()
```

---

## 2) 更新 `setup.py`（安装可执行 + 安装 launch 文件）

打开 `ros2_ws/src/topic_demo/setup.py`

### 关键点 1：导入 `os` 和 `glob`

```python
import os
from glob import glob
```

### 关键点 2：`data_files` 里加入 launch 安装

确保有类似这一段（没有就加）：

```python
data_files=[
    ('share/ament_index/resource_index/packages',
        ['resource/' + package_name]),
    ('share/' + package_name, ['package.xml']),
    (os.path.join('share', package_name, 'launch'), glob('launch/*.launch.py')),
],
```

### 关键点 3：`entry_points` 加上 `talker_param`

在 `console_scripts` 里加入（名称可自定义）：

```python
' talker_param = topic_demo.talker_param:main',
```

完整 `console_scripts` 示例（按你包里实际可执行调整）：

```python
entry_points={
    'console_scripts': [
        'talker = topic_demo.publisher_member_function:main',   # 如果你已有
        'listener = topic_demo.subscriber_member_function:main',# 如果你已有
        'talker_param = topic_demo.talker_param:main',          # ✅ 新增
    ],
},
```

> 如果你 Day1 的 listener 文件名不是这个（比如 `listener.py`），就改成你的真实模块路径。

---

## 3) 确保 `package.xml` 依赖齐全

打开 `ros2_ws/src/topic_demo/package.xml`，确认有这些（没有就补）：

```xml
<exec_depend>rclpy</exec_depend>
<exec_depend>std_msgs</exec_depend>
<exec_depend>launch</exec_depend>
<exec_depend>launch_ros</exec_depend>
```

---

# Part B：写今天核心 `launch/bringup.launch.py`

## 1) 创建目录和文件

```bash
cd ~/Projects/robotics-onboarding-notes/day-2/ros2_ws/src/topic_demo
mkdir -p launch
touch launch/bringup.launch.py
```

> 你的路径可能不是这个，替换成你自己的 `ros2_ws/src/topic_demo`。

---

## 2) `bringup.launch.py` 完整代码（可直接用）

> 默认：
>
> * 启动 `topic_demo/talker_param`
> * 启动 `topic_demo/listener`
> * 可选启动 `service_demo/add_two_ints_server`（Day2）

```python
from launch import LaunchDescription
from launch.actions import DeclareLaunchArgument, LogInfo
from launch.conditions import IfCondition
from launch.substitutions import LaunchConfiguration
from launch_ros.actions import Node
from launch_ros.parameter_descriptions import ParameterValue


def generate_launch_description():
    # ---- Launch 参数（命令行传入）----
    msg_arg = DeclareLaunchArgument(
        'msg',
        default_value='hello from bringup',
        description='Text to publish'
    )

    period_arg = DeclareLaunchArgument(
        'period',
        default_value='1.0',
        description='Publish period in seconds'
    )

    ns_arg = DeclareLaunchArgument(
        'ns',
        default_value='',
        description='Namespace for all nodes (e.g. lab1)'
    )

    topic_name_arg = DeclareLaunchArgument(
        'topic_name',
        default_value='chatter',
        description='Topic name after remapping'
    )

    start_service_arg = DeclareLaunchArgument(
        'start_service',
        default_value='false',
        description='Whether to start add_two_ints service server'
    )

    # ---- LaunchConfiguration（读取参数）----
    msg = LaunchConfiguration('msg')
    period = LaunchConfiguration('period')
    ns = LaunchConfiguration('ns')
    topic_name = LaunchConfiguration('topic_name')
    start_service = LaunchConfiguration('start_service')

    # ---- Publisher ----
    publisher_node = Node(
        package='topic_demo',              # 替换成你的包名
        executable='talker_param',         # 替换成你的 executable
        name='publisher_node',
        namespace=ns,
        output='screen',
        parameters=[{
            'publish_text': ParameterValue(msg, value_type=str),
            'period_sec': ParameterValue(period, value_type=float),
        }],
        remappings=[
            ('chatter', topic_name),       # 代码里用 'chatter'，运行时改成 topic_name
        ]
    )

    # ---- Subscriber ----
    subscriber_node = Node(
        package='topic_demo',              # 替换成你的包名
        executable='listener',             # 替换成你的 executable
        name='subscriber_node',
        namespace=ns,
        output='screen',
        remappings=[
            ('chatter', topic_name),
        ]
    )

    # ---- Optional Service Server (Day2) ----
    service_server_node = Node(
        package='service_demo',            # 替换成你的 Day2 服务包名
        executable='add_two_ints_server',  # 替换成你的 executable
        name='add_two_ints_server',
        namespace=ns,
        output='screen',
        condition=IfCondition(start_service),
    )

    return LaunchDescription([
        msg_arg,
        period_arg,
        ns_arg,
        topic_name_arg,
        start_service_arg,

        LogInfo(msg=['[bringup] ns=', ns,
                     ', topic_name=', topic_name,
                     ', period=', period,
                     ', start_service=', start_service]),

        publisher_node,
        subscriber_node,
        service_server_node,
    ])
```

---

# Part C：编译 + 运行

## 1) 回到 workspace 根目录，编译

```bash
cd ~/Projects/robotics-onboarding-notes/day-2/ros2_ws
colcon build --symlink-install --packages-select topic_demo service_demo
```

> 如果你暂时不启动 service，也可以先只编 `topic_demo`。

## 2) source 环境

```bash
source /opt/ros/$ROS_DISTRO/setup.bash
source install/setup.bash
```

---

## 3) 先看 launch 参数（非常推荐）

```bash
ros2 launch topic_demo bringup.launch.py --show-args
```

你会看到可传的参数列表（`msg`, `period`, `ns`, `topic_name`, `start_service`）。

---

## 4) 最小运行（publisher + subscriber）

```bash
ros2 launch topic_demo bringup.launch.py
```

你应该看到：

* publisher 在屏幕打印 `Publishing: ...`
* subscriber 收到消息并打印（取决于你 listener 的日志）

---

## 5) 传参数进去（今天的重点）

```bash
ros2 launch topic_demo bringup.launch.py msg:="Day4 launch demo" period:=0.5
```

这时 publisher 每 0.5 秒发一次，内容会变成 `Day4 launch demo [n]`

---

## 6) 加命名空间 + topic 重映射（概念体验）

```bash
ros2 launch topic_demo bringup.launch.py ns:=lab1 topic_name:=my_chatter
```

然后另开终端（记得 source）验证：

```bash
ros2 node list
ros2 topic list
ros2 topic echo /lab1/my_chatter
```

你会看到类似：

* `/lab1/publisher_node`
* `/lab1/subscriber_node`
* topic 是 `/lab1/my_chatter`

---

## 7) 可选：一起启动 service server（Day2 串起来）

```bash
ros2 launch topic_demo bringup.launch.py start_service:=true ns:=lab1
```

另开终端验证：

```bash
ros2 service list | grep add_two_ints
```

调用服务（如果加了 `ns:=lab1`）：

```bash
ros2 service call /lab1/add_two_ints example_interfaces/srv/AddTwoInts "{a: 2, b: 5}"
```

如果没加 namespace，就调用：

```bash
ros2 service call /add_two_ints example_interfaces/srv/AddTwoInts "{a: 2, b: 5}"
```

---

# Part D：你今天要交的 `notes/day4_launch.md`（模板可直接贴）

下面这个你可以直接保存成 `notes/day4_launch.md`。

````md
# Day 4 — ROS2 Launch（一键启动多个节点）

## 今日目标
从“能跑单个 demo”升级到“像工程一样启动系统”，用 launch file 一次启动多个节点。

## 我掌握的点
- launch file 的作用：系统编排入口（orchestration）
- 多节点启动：一个 launch 启多个 node
- 参数传递：`ros2 launch pkg file.launch.py arg:=value`
- 命名空间（namespace）：给节点/topic 加前缀，避免冲突
- 重映射（remapping）：运行时把代码里的 topic 名字映射到实际名字

## 本次实现
一次启动：
- publisher node
- subscriber node
- （可选）service server（add_two_ints）

文件：
- `launch/bringup.launch.py`

## 关键代码点
- `DeclareLaunchArgument(...)`：声明命令行参数
- `LaunchConfiguration(...)`：读取 launch 参数
- `Node(...)`：定义要启动的节点
- `parameters=[...]`：传参数给节点
- `remappings=[('chatter', 'my_chatter')]`：topic 重映射
- `namespace='lab1'`：命名空间
- `IfCondition(...)`：可选启动 service server

## 运行命令
### 查看可传参数
```bash
ros2 launch topic_demo bringup.launch.py --show-args
````

### 基础启动

```bash
ros2 launch topic_demo bringup.launch.py
```

### 传参数（消息内容 + 频率）

```bash
ros2 launch topic_demo bringup.launch.py msg:="Day4 launch demo" period:=0.5
```

### 命名空间 + 重映射

```bash
ros2 launch topic_demo bringup.launch.py ns:=lab1 topic_name:=my_chatter
```

### 启动 service server（可选）

```bash
ros2 launch topic_demo bringup.launch.py start_service:=true ns:=lab1
```

## 调试验证命令

```bash
ros2 node list
ros2 topic list
ros2 topic echo /lab1/my_chatter
ros2 service list
ros2 service call /lab1/add_two_ints example_interfaces/srv/AddTwoInts "{a: 2, b: 5}"
```

## 我能讲出来的话（面试/复盘版）

* Launch 是 ROS2 的系统编排入口，用于复现实验、统一配置、快速调试。
* 与其手动开多个终端 `ros2 run`，工程里更常用 `ros2 launch` 管理节点启动。
* 参数/命名空间/remap 让同一套节点代码在不同实验配置下复用。

```

---

# 常见坑（很实用）

## 坑 1：`ros2 launch ... bringup.launch.py` 找不到文件
通常是因为 `setup.py` 没把 `launch/*.launch.py` 安装进去。

检查：
- `setup.py` 是否有 `glob('launch/*.launch.py')`
- 重新 `colcon build`
- 重新 `source install/setup.bash`

---

## 坑 2：`No executable found`
通常是 `setup.py` 的 `entry_points` 没配对：

- `executable='talker_param'` 要对应  
  `console_scripts` 里的 `talker_param = xxx:main`

---

## 坑 3：参数类型不对（尤其 `period`）
比如你传了 `period:=abc`，会报类型转换错误。  
今天先用数字字符串：`0.5`, `1.0`, `2.0`

---

## 坑 4：namespace 后 topic 名字变了，以为没消息
你设置了 `ns:=lab1` 后，topic 很可能变成 `/lab1/xxx`。  
先用 `ros2 topic list` 看真实名字，再 `echo`。

---

# 你今天完成后，建议做的两个小加分项（10分钟）

1. **再加一个 launch 参数**：比如 `pub_node_name`
   - 把 publisher 的 `name='publisher_node'` 改成 launch 参数传入

2. **再加一个 remap**：把 service 名字 remap（先知道也行）
   - 例如将 `/add_two_ints` remap 到 `/math/add`

---

如果你愿意，我下一步可以直接给你 **Day 4 的“检查清单版”**（你做完逐条打勾），或者基于你**实际包名/文件名**给你一份“免替换”的版本。
```

[1]: https://chatgpt.com/c/69a11f6a-f5c0-832b-bd65-6af961be9343 "UTM Ubuntu 共享目录挂载"
[2]: https://chatgpt.com/c/699e7858-a148-8329-b660-c8961af76004 "转型机器人领域建议"
[3]: https://chatgpt.com/c/69a1baf1-8304-8325-ba48-3ed887e25abc "Day 2 ROS2 Service"
[4]: https://chatgpt.com/c/699fd50b-5970-832e-bee6-1eca161c4c23 "ROS2 环境搭建指南"
