ä¸‹é¢ç»™ä½ ä¸€å¥— **å¯ç›´æ¥ç…§ç€æ•²** çš„ Day 2ï¼ˆROS 2 Service è¯·æ±‚/å“åº”ï¼‰å®Œæ•´æ­¥éª¤ï¼šä»æ¦‚å¿µè¾¹ç•Œ â†’ CLI è°ƒç”¨ â†’ æœ€å° server/client â†’ è‡ªå·±æ”¹ä¸€ä¸ªâ€œåŠ æ³•å™¨/çŠ¶æ€æŸ¥è¯¢â€æœåŠ¡ â†’ è¾“å‡ºåˆ° `notes/day2_services.md` å’Œ `service_demo` packageã€‚

> é»˜è®¤ä½ åœ¨ Ubuntu 22.04 + ROS 2 Humbleï¼ˆä½  Day 0/1 çš„è·¯å¾„ä¹Ÿæ˜¯è¿™ä¸ªï¼‰ã€‚å¦‚æœä½ æ˜¯ Jazzy/å…¶ä»–å‘è¡Œç‰ˆï¼ŒæŠŠå‘½ä»¤é‡Œçš„ `humble` ç”¨ `$ROS_DISTRO` ä»£æ›¿å³å¯ã€‚

---

## 0) ä¸€æ¬¡æ€§å‡†å¤‡ï¼šå¼€æ–°ç»ˆç«¯å°±èƒ½ç”¨ ros2 å‘½ä»¤

### 0.1 Source ROS ç¯å¢ƒï¼ˆæ¯ä¸ªæ–°ç»ˆç«¯éƒ½éœ€è¦ï¼Œé™¤éå†™è¿› bashrcï¼‰

```bash
source /opt/ros/$ROS_DISTRO/setup.bash
```

### 0.2ï¼ˆæ¨èï¼‰å†™è¿› ~/.bashrc ä»¥åè‡ªåŠ¨ç”Ÿæ•ˆ

```bash
echo 'source /opt/ros/$ROS_DISTRO/setup.bash' >> ~/.bashrc
source ~/.bashrc
```

### 0.3 å¿«é€ŸéªŒè¯

```bash
ros2 --help
ros2 service --help
```

---

## 1) å…ˆæŠŠâ€œService vs Topicâ€è¾¹ç•Œè®²æ¸…æ¥šï¼ˆä½ éœ€è¦èƒ½è®²å‡ºæ¥ï¼‰

### Topicï¼ˆDay 1ï¼‰

* **è¿ç»­æµ**ï¼šä¼ æ„Ÿå™¨ã€çŠ¶æ€ã€å¿ƒè·³ã€ä½ç½®ã€å›¾åƒâ€¦â€¦
* **å‘å¸ƒ/è®¢é˜…**ï¼šå¼‚æ­¥ã€å¤šå¯¹å¤š
* **ä¸ä¿è¯è°åœ¨å¬**ï¼ˆé™¤éä½ è‡ªå·±åšæœºåˆ¶ï¼‰

### Serviceï¼ˆDay 2ï¼‰

* **ä¸€æ¬¡æ€§è¯·æ±‚â†’ä¸€æ¬¡æ€§å“åº”**ï¼ˆåƒå‡½æ•°è°ƒç”¨ï¼‰
* æ¦‚å¿µä¸Šæ˜¯â€œåŒæ­¥è°ƒç”¨è¯­ä¹‰â€ï¼ˆclient å‘è¯·æ±‚åä¼šç­‰å“åº”ï¼‰
* **é€‚åˆ**ï¼šæŸ¥è¯¢ã€ä¸‹å‘ä¸€æ¬¡æ€§å‘½ä»¤ã€è·å–é…ç½®ã€åšä¸€æ¬¡è®¡ç®—
* **ä¸é€‚åˆé•¿è€—æ—¶ä»»åŠ¡**ï¼šå¦‚æœæœåŠ¡å¤„ç†å¾ˆä¹…ï¼Œclient ä¼šä¸€ç›´ç­‰ã€ä½“éªŒå·®ï¼›å¹¶å‘ä¹Ÿæ›´å®¹æ˜“å¡ä½
  ğŸ‘‰ è¿™å°±æ˜¯ Day 3 Action çš„é“ºå«ï¼šé•¿è€—æ—¶/å¯å–æ¶ˆ/å¯åé¦ˆè¿›åº¦ â†’ ç”¨ Action æ›´åˆé€‚ã€‚

### Service discoveryï¼ˆçŸ¥é“å°±è¡Œï¼‰

* ROS 2 é‡Œä½ ä¸ç”¨å†™â€œåœ°å€/ç«¯å£â€
* é€šè¿‡ DDS åš discoveryï¼šèŠ‚ç‚¹å¯åŠ¨åè‡ªåŠ¨å‘ç°â€œæœ‰å“ªäº› serviceâ€ã€ç±»å‹æ˜¯ä»€ä¹ˆ

---

## 2) ä»»åŠ¡ 1ï¼šç”¨ CLI è°ƒä¸€æ¬¡ serviceï¼ˆæœ€ç®€å•ï¼šturtlesim çš„ resetï¼‰

> è¿™ä¸€æ­¥å¾ˆé€‚åˆç»ƒæ‰‹ï¼šä½ èƒ½çœ‹åˆ°ç³»ç»Ÿé‡Œæœ‰å“ªäº› serviceã€service çš„ç±»å‹ã€å¹¶ä¸”èƒ½ç”¨ CLI ç›´æ¥ callã€‚

### 2.1 å¼€ç»ˆç«¯ Aï¼šå¯åŠ¨ turtlesim

```bash
ros2 run turtlesim turtlesim_node
```

ä½ ä¼šçœ‹åˆ°ä¸€ä¸ªå°ä¹Œé¾Ÿçª—å£ã€‚

### 2.2 å¼€ç»ˆç«¯ Bï¼šåˆ—å‡ºå½“å‰ service

```bash
ros2 service list
```

ä½ åº”è¯¥èƒ½çœ‹åˆ°ç±»ä¼¼ï¼š

* `/clear`
* `/reset`
* `/spawn`
* `/turtle1/teleport_absolute`
* â€¦

### 2.3 çœ‹æŸä¸ª service çš„ç±»å‹

```bash
ros2 service type /reset
```

é€šå¸¸ä¼šè¿”å›ï¼š

```text
std_srvs/srv/Empty
```

### 2.4 çœ‹è¿™ä¸ª srv çš„ç»“æ„ï¼ˆè¯·æ±‚/å“åº”å­—æ®µï¼‰

```bash
ros2 interface show std_srvs/srv/Empty
```

ä½ ä¼šçœ‹åˆ°å®ƒæ˜¯ç©ºè¯·æ±‚ã€ç©ºå“åº”ï¼ˆåªæœ‰åˆ†éš”çº¿ï¼‰ã€‚

### 2.5 ç”¨ CLI è°ƒ serviceï¼ˆé‡ç½®ä¹Œé¾Ÿï¼‰

```bash
ros2 service call /reset std_srvs/srv/Empty {}
```

å¦‚æœæˆåŠŸï¼Œä¹Œé¾Ÿä¼šå›åˆ°åˆå§‹ä½ç½®ã€‚

> ä½ å·²ç»å®Œæˆäº† â€œç”¨ CLI è°ƒä¸€æ¬¡ serviceâ€ã€‚

---

## 3) ä»»åŠ¡ 2ï¼šè·‘ä¸€ä¸ªæœ€å° server/clientï¼ˆå®˜æ–¹ demoï¼šAddTwoIntsï¼‰

æˆ‘ä»¬ç”¨å®˜æ–¹æœ€ç»å…¸çš„ demoï¼š**åŠ æ³•æœåŠ¡**ã€‚

### 3.1 å»º workspaceï¼ˆå¦‚æœä½  Day 1 å·²ç»æœ‰äº†å°±å¤ç”¨ï¼‰

```bash
mkdir -p ~/ros2_ws/src
cd ~/ros2_ws
```

### 3.2 æ–°å»º packageï¼ˆPythonï¼‰

```bash
cd ~/ros2_ws/src
ros2 pkg create service_demo --build-type ament_python --dependencies rclpy example_interfaces
```

> `example_interfaces` é‡ŒåŒ…å« `AddTwoInts` æœåŠ¡å®šä¹‰ã€‚

### 3.3 å†™ server èŠ‚ç‚¹ï¼š`service_demo/add_two_ints_server.py`

```bash
cd ~/ros2_ws/src/service_demo/service_demo
nano add_two_ints_server.py
```

ç²˜è´´ä¸‹é¢å†…å®¹ï¼š

```python
import rclpy
from rclpy.node import Node
from example_interfaces.srv import AddTwoInts


class AddTwoIntsServer(Node):
    def __init__(self):
        super().__init__('add_two_ints_server')
        self.srv = self.create_service(AddTwoInts, 'add_two_ints', self.add_callback)
        self.get_logger().info('Service [add_two_ints] ready.')

    def add_callback(self, request, response):
        a = request.a
        b = request.b
        response.sum = a + b
        self.get_logger().info(f'Request: a={a}, b={b} -> sum={response.sum}')
        return response


def main():
    rclpy.init()
    node = AddTwoIntsServer()
    rclpy.spin(node)
    node.destroy_node()
    rclpy.shutdown()


if __name__ == '__main__':
    main()
```

### 3.4 å†™ client èŠ‚ç‚¹ï¼š`service_demo/add_two_ints_client.py`

```bash
nano add_two_ints_client.py
```

ç²˜è´´ï¼š

```python
import sys
import rclpy
from rclpy.node import Node
from example_interfaces.srv import AddTwoInts


class AddTwoIntsClient(Node):
    def __init__(self):
        super().__init__('add_two_ints_client')
        self.cli = self.create_client(AddTwoInts, 'add_two_ints')
        while not self.cli.wait_for_service(timeout_sec=1.0):
            self.get_logger().info('Service not available, waiting...')

        self.req = AddTwoInts.Request()

    def send_request(self, a: int, b: int):
        self.req.a = a
        self.req.b = b
        return self.cli.call_async(self.req)


def main():
    rclpy.init()

    if len(sys.argv) != 3:
        print('Usage: ros2 run service_demo add_two_ints_client A B')
        return

    a = int(sys.argv[1])
    b = int(sys.argv[2])

    node = AddTwoIntsClient()
    future = node.send_request(a, b)

    rclpy.spin_until_future_complete(node, future)

    if future.result() is not None:
        node.get_logger().info(f'Result: {a} + {b} = {future.result().sum}')
    else:
        node.get_logger().error('Service call failed.')

    node.destroy_node()
    rclpy.shutdown()


if __name__ == '__main__':
    main()
```

### 3.5 æŠŠè„šæœ¬æ³¨å†Œä¸ºå¯æ‰§è¡Œ entry pointï¼ˆå…³é”®æ­¥éª¤ï¼‰

æ‰“å¼€ `~/ros2_ws/src/service_demo/setup.py`ï¼š

```bash
cd ~/ros2_ws/src/service_demo
nano setup.py
```

æ‰¾åˆ° `entry_points`ï¼Œæ”¹æˆç±»ä¼¼è¿™æ ·ï¼ˆä¿ç•™ä½ åŸæ¥çš„ package_nameï¼‰ï¼š

```python
entry_points={
    'console_scripts': [
        'add_two_ints_server = service_demo.add_two_ints_server:main',
        'add_two_ints_client = service_demo.add_two_ints_client:main',
    ],
},
```

### 3.6 ç¡®ä¿ python æ–‡ä»¶å¯æ‰§è¡Œï¼ˆå¯é€‰ä½†æ¨èï¼‰

```bash
chmod +x ~/ros2_ws/src/service_demo/service_demo/add_two_ints_server.py
chmod +x ~/ros2_ws/src/service_demo/service_demo/add_two_ints_client.py
```

### 3.7 ç¼–è¯‘ & source

```bash
cd ~/ros2_ws
colcon build --packages-select service_demo
source install/setup.bash
```

### 3.8 è¿è¡Œï¼šå…ˆ server å client

ç»ˆç«¯ Aï¼š

```bash
source ~/ros2_ws/install/setup.bash
ros2 run service_demo add_two_ints_server
```

ç»ˆç«¯ Bï¼š

```bash
source ~/ros2_ws/install/setup.bash
ros2 run service_demo add_two_ints_client 7 35
```

ä½ ä¼šçœ‹åˆ°ï¼š

* server æ‰“å°æ”¶åˆ°è¯·æ±‚
* client æ‰“å°ç»“æœ

### 3.9 å†ç”¨ CLI è°ƒä¸€æ¬¡ä½ è‡ªå·±çš„ serviceï¼ˆåŠ æ·±ç†è§£ï¼‰

```bash
ros2 service list | grep add_two_ints
ros2 service type /add_two_ints
ros2 interface show example_interfaces/srv/AddTwoInts

ros2 service call /add_two_ints example_interfaces/srv/AddTwoInts "{a: 10, b: 20}"
```

---

## 4) ä»»åŠ¡ 3ï¼šè‡ªå·±æ”¹ä¸€ä¸ªå°æœåŠ¡ï¼ˆç»™ä½ ä¸¤ä¸ªé€‰é¡¹ï¼‰

### é€‰é¡¹ Aï¼šåŠ æ³•å™¨å‡çº§ç‰ˆï¼ˆå¸¦â€œå»¶è¿Ÿâ€æ¨¡æ‹Ÿé•¿è€—æ—¶ï¼Œè®©ä½ ç›´è§‚çœ‹åˆ°ä¸é€‚åˆï¼‰

æŠŠ server callback æ”¹æˆâ€œç¡ 5 ç§’å†è¿”å›â€ï¼Œä½ ä¼šå‘ç° client ä¼šä¸€ç›´ç­‰ã€‚

åœ¨ `add_callback` é‡ŒåŠ ï¼š

```python
import time
time.sleep(5)
```

ç„¶åé‡æ–° build + runï¼Œä½ å°±èƒ½ç”¨äº‹å®è¯æ˜ï¼š

* service å¯¹é•¿è€—æ—¶ä¸å‹å¥½ï¼ˆDay 3 Action çš„åŠ¨æœºï¼‰

### é€‰é¡¹ Bï¼šçŠ¶æ€æŸ¥è¯¢ï¼ˆæ›´è´´è¿‘æœºå™¨äººï¼‰

åšä¸€ä¸ª serviceï¼š`get_status`ï¼Œè¿”å›å½“å‰è®¡æ•°å™¨/æ—¶é—´æˆ³ç­‰çŠ¶æ€ã€‚
ä¸è¿‡è¿™ä¸ªéœ€è¦ä½ å®šä¹‰è‡ªå®šä¹‰ `.srv`ï¼ˆæ¯” A å¤šå‡ æ­¥ï¼‰ã€‚å¦‚æœä½ æƒ³ Day 2 å°±ç»ƒè‡ªå®šä¹‰ srvï¼Œæˆ‘ä¹Ÿå¯ä»¥ç»™ä½ å®Œæ•´æ­¥éª¤ï¼ˆåˆ›å»º `srv/GetStatus.srv`ã€æ”¹ `package.xml`ã€`setup.cfg`ã€`CMakeLists`/`ament_python` çš„æ¥å£ç”Ÿæˆç­‰ï¼‰ã€‚
**ä½†å°±â€œæœ€å°å¯æ‰§è¡Œâ€è€Œè¨€ï¼ŒA æ›´å¿«å®Œæˆ Day 2ã€‚**

> æˆ‘å»ºè®® Day 2 å…ˆåš Aï¼ŒDay 3/4 å†åšè‡ªå®šä¹‰ srv + actionï¼Œä¼šæ›´é¡ºæ»‘ã€‚

---

## 5) è¾“å‡ºç‰©ï¼šnotes/day2_services.mdï¼ˆç»™ä½ æ¨¡æ¿ç›´æ¥ç”¨ï¼‰

åœ¨ä½ çš„ repo é‡Œï¼ˆæ¯”å¦‚ `robotics-week0-notes`ï¼‰ï¼Œåˆ›å»ºæ–‡ä»¶ï¼š

```bash
mkdir -p notes
nano notes/day2_services.md
```

ç›´æ¥ç²˜è´´å¹¶æŒ‰ä½ çš„å®é™…ç»“æœå¡«ç©ºï¼š

````md
# Day 2 â€” ROS2 Serviceï¼ˆè¯·æ±‚/å“åº”ï¼‰

## ç›®æ ‡
ç†è§£ Service ä¸ Topic çš„è¾¹ç•Œï¼›èƒ½ç”¨ CLI è°ƒç”¨ serviceï¼›èƒ½è·‘ä¸€ä¸ªæœ€å° server/clientï¼›å¹¶åšä¸€æ¬¡å°æ”¹åŠ¨éªŒè¯â€œservice ä¸é€‚åˆé•¿è€—æ—¶â€ã€‚

---

## æ ¸å¿ƒæ¦‚å¿µ

### Service æ˜¯ä»€ä¹ˆ
- ä¸€æ¬¡æ€§ Request/Responseï¼ˆåƒå‡½æ•°è°ƒç”¨ï¼‰
- Client å‘è¯·æ±‚åæ¦‚å¿µä¸Šä¼šç­‰å¾…å“åº”ï¼ˆåŒæ­¥è¯­ä¹‰ï¼›å®ç°ä¸Šå¯ async futureï¼‰
- ROS2 æ”¯æŒ service discoveryï¼šæ— éœ€é…ç½®åœ°å€ï¼ŒèŠ‚ç‚¹å¯è‡ªåŠ¨å‘ç°æœåŠ¡

### å’Œ Topic çš„è¾¹ç•Œ
- Topicï¼šè¿ç»­æµã€å¼‚æ­¥ã€å¤šå¯¹å¤šï¼ˆé€‚åˆä¼ æ„Ÿå™¨ã€çŠ¶æ€æ›´æ–°ï¼‰
- Serviceï¼šä¸€æ¬¡æ€§è¯·æ±‚å“åº”ï¼ˆé€‚åˆæŸ¥è¯¢/ä¸€æ¬¡å‘½ä»¤/ä¸€æ¬¡è®¡ç®—ï¼‰
- Service ä¸é€‚åˆé•¿è€—æ—¶ï¼šclient ä¼šä¸€ç›´ç­‰å¾…ï¼Œå®¹æ˜“é˜»å¡ï¼›æ›´é€‚åˆç”¨ Actionï¼ˆDay 3ï¼‰

---

## CLI æ“ä½œè®°å½•

### å¯åŠ¨ turtlesim å¹¶æŸ¥çœ‹ service
```bash
ros2 run turtlesim turtlesim_node
ros2 service list
ros2 service type /reset
ros2 interface show std_srvs/srv/Empty
ros2 service call /reset std_srvs/srv/Empty {}
````

è§‚å¯Ÿï¼š

* /reset ç±»å‹ä¸º std_srvs/srv/Empty
* è°ƒç”¨åä¹Œé¾Ÿé‡ç½®æˆåŠŸ

---

## æœ€å° Service Demoï¼šAddTwoInts

### åˆ›å»º package

```bash
mkdir -p ~/ros2_ws/src
cd ~/ros2_ws/src
ros2 pkg create service_demo --build-type ament_python --dependencies rclpy example_interfaces
```

### ç¼–è¯‘è¿è¡Œ

```bash
cd ~/ros2_ws
colcon build --packages-select service_demo
source install/setup.bash

# terminal A
ros2 run service_demo add_two_ints_server

# terminal B
ros2 run service_demo add_two_ints_client 7 35
```

### ç”¨ CLI è°ƒç”¨è‡ªå®šä¹‰ service

```bash
ros2 service call /add_two_ints example_interfaces/srv/AddTwoInts "{a: 10, b: 20}"
```

---

## å°æ”¹åŠ¨ï¼šæ¨¡æ‹Ÿé•¿è€—æ—¶ï¼ˆè¯æ˜ service ä¸é€‚åˆï¼‰

åœ¨ server å›è°ƒé‡Œ sleep(5) åå†è¿”å›ã€‚

ç°è±¡ï¼š

* client ä¼šä¸€ç›´ç­‰å¾…ç»“æœ
* è¯´æ˜é•¿è€—æ—¶ä»»åŠ¡ä¸é€‚åˆç”¨ serviceï¼Œé€‚åˆ action

```

---

## 6) å¸¸è§å‘ï¼ˆä½ å¾ˆå¯èƒ½ä¼šé‡åˆ°ï¼‰

- **å¿˜äº† `source install/setup.bash`**ï¼šå¯¼è‡´ `ros2 run service_demo ...` æ‰¾ä¸åˆ°å¯æ‰§è¡Œ
- `setup.py` **æ²¡åŠ  entry_points**ï¼šbuild æˆåŠŸä½† run ä¸å‡ºæ¥
- service åå­—è¦ä¸€è‡´ï¼šserver åˆ›å»ºçš„æ˜¯ `'add_two_ints'`ï¼Œclient ä¹Ÿè¦è¿è¿™ä¸ª
- è°ƒ CLI æ—¶ YAML æ ¼å¼è¦å¯¹ï¼š`"{a: 1, b: 2}"`

---

å¦‚æœä½ æ„¿æ„æŠŠ Day 2 åšå¾—æ›´â€œæœºå™¨äººå‘³â€ä¸€ç‚¹ï¼šæˆ‘ä¹Ÿå¯ä»¥ç»™ä½  **è‡ªå®šä¹‰ srv çš„ GetStatus**ï¼ˆæ¯”å¦‚è¿”å› `uptime_sec`ã€`request_count`ã€`node_name`ï¼‰ï¼Œé‚£ä¼šæ›´è´´è¿‘â€œçŠ¶æ€æŸ¥è¯¢â€è¿™ä¸ªçœŸå®åœºæ™¯ã€‚ä½ å…ˆæŒ‰ä¸Šé¢ A è·‘é€šï¼Œæˆ‘å†ç»™ä½  B çš„å®Œæ•´è‡ªå®šä¹‰æ¥å£ç”Ÿæˆæ­¥éª¤ä¹Ÿè¡Œã€‚
```
